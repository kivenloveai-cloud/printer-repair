<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‰“å°æœºç»´ä¿®è®°å½•ç®¡ç†</title>
  <style>
    :root {
      --bg: #f5f5f7;
      --surface: #ffffff;
      --border: #e2e2e5;
      --primary: #4f46e5;
      --primary-soft: rgba(79, 70, 229, 0.08);
      --user-msg: #4f46e5;
      --bot-msg: #f4f4f5;
      --text: #1a1a2e;
      --text-muted: #6b7280;
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --radius: 12px;
      --font: system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
      margin: 0;
    }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
    }
    .form-input:focus { outline: none; border-color: var(--primary); }

    .error-msg {
      color: var(--danger);
      font-size: 0.85rem;
      text-align: center;
      margin-top: 12px;
      min-height: 20px;
    }

    /* ===== å…¨å±ç™»å½•é¡µ ===== */
    .login-page {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      transition: opacity 0.5s, visibility 0.5s;
    }
    .login-page.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .login-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      overflow: hidden;
    }
    .login-bg-circle {
      position: absolute;
      border-radius: 50%;
      opacity: 0.08;
      background: #fff;
    }
    .login-bg-circle.c1 {
      width: 600px; height: 600px;
      top: -200px; right: -100px;
      animation: float1 20s ease-in-out infinite;
    }
    .login-bg-circle.c2 {
      width: 400px; height: 400px;
      bottom: -150px; left: -80px;
      animation: float2 18s ease-in-out infinite;
    }
    .login-bg-circle.c3 {
      width: 250px; height: 250px;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      animation: float3 15s ease-in-out infinite;
    }
    @keyframes float1 {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(-30px, 40px); }
    }
    @keyframes float2 {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(40px, -30px); }
    }
    @keyframes float3 {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
    }

    .login-card {
      position: relative;
      z-index: 1;
      width: 420px;
      max-width: 92vw;
      padding: 48px 40px 36px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.3);
      text-align: center;
      animation: cardSlideIn 0.6s ease-out;
    }
    @keyframes cardSlideIn {
      from { opacity: 0; transform: translateY(30px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .login-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 72px; height: 72px;
      border-radius: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.35);
    }

    .login-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 6px;
      letter-spacing: -0.02em;
    }
    .login-subtitle {
      font-size: 0.88rem;
      color: var(--text-muted);
      margin-bottom: 32px;
    }

    .login-form {
      text-align: left;
    }
    .login-field {
      margin-bottom: 20px;
    }
    .login-label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      letter-spacing: 0.02em;
    }
    .login-input-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 14px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--bg);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .login-input-wrap:focus-within {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
    }
    .login-input-icon {
      flex-shrink: 0;
      color: var(--text-muted);
    }
    .login-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      padding: 13px 0;
      font-size: 0.95rem;
      color: var(--text);
    }
    .login-input::placeholder {
      color: #b0b0b8;
    }

    .login-error {
      color: var(--danger);
      font-size: 0.83rem;
      text-align: center;
      min-height: 22px;
      margin-bottom: 4px;
    }

    .login-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.2s;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
      letter-spacing: 0.05em;
    }
    .login-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 24px rgba(102, 126, 234, 0.45);
    }
    .login-btn:active {
      transform: translateY(0);
    }
    .login-btn-arrow {
      transition: transform 0.2s;
    }
    .login-btn:hover .login-btn-arrow {
      transform: translateX(3px);
    }

    .login-footer {
      margin-top: 28px;
      font-size: 0.75rem;
      color: #aaa;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 550px;
      max-height: 92vh;
      overflow-y: auto;
    }
    .modal.modal-wide {
      max-width: 860px;
    }
    .edit-form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .modal.modal-wide .form-group { margin-bottom: 6px; }
    .modal.modal-wide .form-label { margin-bottom: 2px; font-size: 0.78rem; }
    .modal.modal-wide .form-input { padding: 7px 10px; font-size: 0.84rem; }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title { font-size: 1.1rem; font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text); }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #5558e3; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-danger { background: var(--danger); color: #fff; }

    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

    /* ç®¡ç†è¡¨æ ¼æ ·å¼ */
    .device-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .device-table th {
      padding: 8px 6px;
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 1;
    }
    .device-table td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .device-table tr:hover td { background: rgba(99, 102, 241, 0.05); }
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.72rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .status-badge.å·²æ”¶ä»¶ { background: rgba(99,102,241,0.15); color: var(--primary); }
    .status-badge.æœªæŠ¥ä»· { background: rgba(245,158,11,0.15); color: var(--warning); }
    .status-badge.å·²æŠ¥ä»· { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .status-badge.å¾…ç»´ä¿® { background: rgba(245,158,11,0.15); color: var(--warning); }
    .status-badge.å¾…å‘è´§ { background: rgba(168,85,247,0.15); color: #a855f7; }
    .status-badge.å·²å‘è´§ { background: rgba(34,197,94,0.15); color: var(--success); }
    .status-badge.ä¿å¤–æ”¶è´¹ { background: rgba(239,68,68,0.15); color: var(--danger); }
    .status-badge.ä¿å†…å…è´¹ { background: rgba(34,197,94,0.15); color: var(--success); }
    .status-badge.æ–°æœºæ¢æ–° { background: rgba(245,158,11,0.15); color: var(--warning); }
    .status-badge.ä»¥æ—§æ¢æ–° { background: rgba(168,85,247,0.15); color: #a855f7; }
    .action-btns { display: flex; gap: 4px; white-space: nowrap; }
    .action-btn {
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.72rem;
    }
    .action-btn:hover { border-color: var(--primary); color: var(--primary); }
    .action-btn.del:hover { border-color: var(--danger); color: var(--danger); }

    /* ç®¡ç†é¢æ¿ï¼ˆå…¨å±ï¼‰ */
    .admin-panel {
      display: none;
      width: 100%;
      max-width: 100%;
      height: 96vh;
      flex-direction: column;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }
    .admin-panel.show { display: flex; }
    .admin-panel .header { flex-shrink: 0; }
    .filter-bar {
      display: flex;
      gap: 10px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar .form-input, .filter-bar select {
      padding: 8px 10px;
      font-size: 0.82rem;
      width: auto;
      min-width: 0;
    }
    .filter-item { display: flex; flex-direction: column; gap: 2px; }
    .filter-item label { font-size: 0.7rem; color: var(--text-muted); }
    .table-wrap {
      flex: 1;
      overflow: auto;
      padding: 0;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      white-space: nowrap;
    }
    .admin-table th {
      padding: 10px 8px;
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 1;
      position: relative;
    }
    .admin-table th .col-resizer {
      position: absolute;
      right: 0; top: 0; bottom: 0;
      width: 5px;
      cursor: col-resize;
      user-select: none;
    }
    .admin-table th .col-resizer:hover,
    .admin-table th .col-resizer.active { background: var(--primary); }
    .admin-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }
    .admin-table tr:hover td { background: rgba(99, 102, 241, 0.05); }
    .admin-table .sn-cell { color: var(--primary); font-weight: 600; }
    .expand-row td { padding: 0 !important; border-bottom: 2px solid var(--primary); }
    .expand-content {
      padding: 12px 16px;
      background: var(--bg);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 8px 20px;
      font-size: 0.8rem;
      overflow: visible;
    }
    .expand-item { display: flex; gap: 6px; min-height: 0; }
    .expand-item-full { grid-column: 1 / -1; }
    .expand-label { color: var(--text-muted); white-space: nowrap; min-width: 80px; flex-shrink: 0; }
    .expand-value { color: var(--text); word-break: break-all; white-space: pre-wrap; line-height: 1.5; }
    .expand-toggle {
      cursor: pointer;
      color: var(--primary);
      font-size: 0.7rem;
      background: var(--primary-soft);
      border: 1px solid rgba(79,70,229,0.2);
      border-radius: 4px;
      padding: 2px 6px;
      white-space: nowrap;
      transition: all 0.15s;
    }
    .expand-toggle:hover { background: var(--primary); color: #fff; }

    /* æ—¥å¿—æ¡ç›® */
    .log-entry {
      border-left: 3px solid var(--primary);
      padding: 10px 14px;
      margin-bottom: 10px;
      background: var(--bg);
      border-radius: 0 8px 8px 0;
      font-size: 0.82rem;
    }
    .log-entry.log-add { border-left-color: var(--success); }
    .log-entry.log-edit { border-left-color: var(--primary); }
    .log-entry.log-delete { border-left-color: var(--danger); }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .log-header .log-action {
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 0.72rem;
    }
    .log-add .log-action { background: rgba(22,163,74,0.1); color: var(--success); }
    .log-edit .log-action { background: var(--primary-soft); color: var(--primary); }
    .log-delete .log-action { background: rgba(220,38,38,0.1); color: var(--danger); }
    .log-changes {
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.6;
    }
    .log-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 30px 0;
      font-size: 0.88rem;
    }

    /* åˆ—è®¾ç½®å¼¹çª— */
    .col-settings-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3); z-index: 200; display: none;
      align-items: center; justify-content: center;
    }
    .col-settings-overlay.show { display: flex; }
    .col-settings-box {
      background: var(--surface); border-radius: 12px; padding: 20px;
      width: 380px; max-height: 80vh; overflow-y: auto;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }
    .col-settings-box h3 { margin-bottom: 12px; font-size: 1rem; }
    .col-item {
      display: flex; align-items: center; gap: 8px; padding: 6px 0;
      border-bottom: 1px solid var(--border); cursor: grab;
    }
    .col-item:active { cursor: grabbing; }
    .col-item label { flex: 1; font-size: 0.85rem; cursor: pointer; }
    .admin-stats {
      padding: 8px 20px;
      border-top: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-muted);
      flex-shrink: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tab-btns { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.85rem;
    }
    .tab-btn.active { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-header-btn {
      padding: 6px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .tab-header-btn.active { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }
    .tab-header-btn:hover { color: var(--primary); }
    .hidden { display: none !important; }
    .multi-select { position: relative; }
    .multi-select-display {
      padding: 7px 10px; border: 1px solid var(--border); border-radius: 8px;
      background: var(--surface); cursor: pointer; font-size: 0.84rem; color: var(--text);
      min-height: 36px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px;
    }
    .multi-select-display:hover { border-color: var(--primary); }
    .multi-select-display.open { border-color: var(--primary); border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    .multi-select-tag {
      background: var(--primary-soft); color: var(--primary); padding: 2px 8px;
      border-radius: 4px; font-size: 0.76rem; white-space: nowrap;
    }
    .multi-select-placeholder { color: var(--text-muted); }
    .multi-select-dropdown {
      display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 10;
      background: var(--surface); border: 1px solid var(--primary); border-top: none;
      border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
      max-height: 180px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .multi-select-dropdown.open { display: block; }
    .multi-select-option {
      padding: 6px 10px; cursor: pointer; font-size: 0.82rem;
      display: flex; align-items: center; gap: 8px; transition: background 0.1s;
    }
    .multi-select-option:hover { background: var(--primary-soft); }
    .multi-select-option input[type="checkbox"] { accent-color: var(--primary); }

    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(79, 70, 229, 0.04) 0%, transparent 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left h1 { font-size: 1.1rem; font-weight: 600; }
    .header-left p { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
    .header-right { display: flex; gap: 8px; }
    .icon-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    .icon-btn:hover { border-color: var(--primary); color: var(--primary); }

    /* æ‰‹æœºç«¯é€‚é… */
    @media (max-width: 768px) {
      body { padding: 0; }
      .login-card { padding: 32px 24px 28px; max-width: 95vw; }
      .login-title { font-size: 1.25rem; }
      .admin-panel {
        max-width: 100%;
        height: 100vh;
        border-radius: 0;
        border: none;
        box-shadow: none;
      }
      .admin-panel .header {
        flex-wrap: wrap;
        padding: 10px 12px;
        gap: 8px;
      }
      .header-left { width: 100%; }
      .header-right { width: 100%; display: flex; flex-wrap: wrap; gap: 6px; }
      .filter-bar {
        padding: 8px 12px;
        gap: 6px;
      }
      .filter-bar .form-input, .filter-bar select {
        font-size: 0.78rem;
        padding: 6px 8px;
        min-width: 80px;
      }
      .tab-header-btn { font-size: 0.78rem; padding: 4px 10px; }
      .admin-table { font-size: 0.72rem; }
      .admin-table th, .admin-table td { padding: 6px 8px; }
      .action-btn { font-size: 0.68rem; padding: 2px 5px; }
      .expand-toggle { font-size: 0.65rem; padding: 1px 4px; }
      .modal { width: 95%; padding: 16px; }
      .modal.modal-wide { max-width: 95vw; }
      .edit-form-grid {
        grid-template-columns: 1fr !important;
      }
      .edit-form-grid .form-group[style*="grid-column"] {
        grid-column: span 1 !important;
      }
      .expand-content { grid-template-columns: 1fr; }
      .log-entry { font-size: 0.78rem; }
      .log-header { flex-direction: column; gap: 4px; }
    }

    @media (max-width: 480px) {
      .btn { font-size: 0.75rem !important; padding: 5px 10px !important; }
      .icon-btn { width: 30px; height: 30px; font-size: 0.85rem; }
      .admin-table { font-size: 0.68rem; }
      .admin-table th, .admin-table td { padding: 4px 6px; }
      .filter-bar .form-input, .filter-bar select { font-size: 0.72rem; }
    }
  </style>
</head>
<body>
  <!-- æ–°å¢/ç¼–è¾‘è®¾å¤‡å¼¹çª— -->
  <div class="modal-overlay" id="editModal">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3 class="modal-title" id="editModalTitle">æ–°å¢ç»´ä¿®è®°å½•</h3>
        <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editMode" value="add">
        <input type="hidden" id="editId" value="">
        <div class="edit-form-grid">
          <div class="form-group">
            <label class="form-label">å®¢æˆ·ç¼–å·</label>
            <input type="text" class="form-input" id="editCustomerId" placeholder="å®¢æˆ·ç¼–å·">
          </div>
          <div class="form-group">
            <label class="form-label">æ‰“å°æœºå‹å· *</label>
            <select class="form-input" id="editModel">
              <option value=""></option>
              <option value="L36">L36</option>
              <option value="TL58">TL58</option>
              <option value="L53i">L53i</option>
              <option value="TL54U">TL54U</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">åºåˆ—å· *</label>
            <input type="text" class="form-input" id="editSN" placeholder="è¯·è¾“å…¥åºåˆ—å·">
          </div>
          <div class="form-group">
            <label class="form-label">MACåœ°å€ *</label>
            <input type="text" class="form-input" id="editMAC" placeholder="DC:0D:30:32:57:E4">
          </div>
          <div class="form-group">
            <label class="form-label">è´­ä¹°æ—¥æœŸ *</label>
            <div style="display:flex;gap:4px;align-items:center;">
              <input type="text" class="form-input" id="editPurchaseDate" placeholder="ç²˜è´´æˆ–è¾“å…¥æ—¥æœŸ" style="flex:1;">
              <button type="button" class="btn btn-secondary" style="padding:8px 10px;font-size:0.85rem;white-space:nowrap;" onclick="var el=document.getElementById('editPurchaseDatePicker');el.showPicker?el.showPicker():el.click()">ğŸ“…</button>
              <input type="date" id="editPurchaseDatePicker" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;" onchange="document.getElementById('editPurchaseDate').value=this.value;document.getElementById('editPurchaseDate').dispatchEvent(new Event('change'))">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ç»´ä¿é€‰æ‹©</label>
            <select class="form-input" id="editWarrantyType">
              <option value=""></option>
              <option value="æ–°æœºæ¢æ–°">æ–°æœºæ¢æ–°</option>
              <option value="ä¿å†…å…è´¹">ä¿å†…å…è´¹</option>
              <option value="ä¿å¤–æ”¶è´¹">ä¿å¤–æ”¶è´¹</option>
              <option value="ä»¥æ—§æ¢æ–°">ä»¥æ—§æ¢æ–°</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ç»´ä¿®çŠ¶æ€</label>
            <select class="form-input" id="editRepairStatus">
              <option value="å·²æ”¶ä»¶">å·²æ”¶ä»¶</option>
              <option value="æœªæŠ¥ä»·">æœªæŠ¥ä»·</option>
              <option value="å·²æŠ¥ä»·">å·²æŠ¥ä»·</option>
              <option value="å¾…ç»´ä¿®">å¾…ç»´ä¿®</option>
              <option value="å¾…å‘è´§">å¾…å‘è´§</option>
              <option value="å·²å‘è´§">å·²å‘è´§</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ç™»è®°æ—¥æœŸ</label>
            <div style="display:flex;gap:4px;align-items:center;">
              <input type="text" class="form-input" id="editRegisterDate" placeholder="ç²˜è´´æˆ–è¾“å…¥æ—¥æœŸ" style="flex:1;">
              <button type="button" class="btn btn-secondary" style="padding:8px 10px;font-size:0.85rem;white-space:nowrap;" onclick="var el=document.getElementById('editRegisterDatePicker');el.showPicker?el.showPicker():el.click()">ğŸ“…</button>
              <input type="date" id="editRegisterDatePicker" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;" onchange="document.getElementById('editRegisterDate').value=this.value;document.getElementById('editRegisterDate').dispatchEvent(new Event('change'))">
            </div>
          </div>
          <div class="form-group" style="grid-column:span 2;">
            <label class="form-label">éœ€æ›´æ¢é…ä»¶</label>
            <div class="multi-select" id="editPartsMulti">
              <div class="multi-select-display" id="editPartsDisplay" onclick="togglePartsDropdown()">è¯·é€‰æ‹©é…ä»¶...</div>
              <div class="multi-select-dropdown" id="editPartsDropdown"></div>
            </div>
            <input type="hidden" id="editParts">
          </div>
          <div class="form-group">
            <label class="form-label">éœ€ä»˜è´¹</label>
            <div id="editFeeDisplay" style="font-size:0.88rem;padding:7px 0;color:var(--text);font-weight:600;">-</div>
          </div>
          <div class="form-group">
            <label class="form-label">å¯„å›å¿«é€’å•å·</label>
            <input type="text" class="form-input" id="editReturnTracking" placeholder="å®¢æˆ·å¯„æ¥çš„å¿«é€’å•å·">
          </div>
          <div class="form-group">
            <label class="form-label">å¯„å‡ºå¿«é€’å•å·</label>
            <input type="text" class="form-input" id="editSendTracking" placeholder="å¯„å›å®¢æˆ·çš„å¿«é€’å•å·">
          </div>
          <div class="form-group" style="grid-column:span 3;">
            <label class="form-label">å¯„å›åœ°å€</label>
            <input type="text" class="form-input" id="editReturnAddress" placeholder="å®¢æˆ·å¯„å›åœ°å€">
          </div>
          <div class="form-group" style="grid-column:span 3;">
            <label class="form-label">æ•…éšœæè¿°</label>
            <input type="text" class="form-input" id="editFaultDesc" placeholder="æè¿°æ‰“å°æœºæ•…éšœæƒ…å†µ">
          </div>
          <div class="form-group" style="grid-column:span 3;">
            <label class="form-label">å¤‡æ³¨</label>
            <input type="text" class="form-input" id="editRemark" placeholder="å…¶ä»–å¤‡æ³¨ä¿¡æ¯">
          </div>
        </div>
        <div class="btn-row" style="margin-top:12px;">
          <button type="submit" class="btn btn-primary" id="editSubmitBtn">æ·»åŠ </button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ç®¡ç†é¢æ¿ï¼ˆå…¨å±è¡¨æ ¼ï¼‰ -->
  <div class="admin-panel" id="adminPanel">
    <header class="header">
      <div class="header-left">
        <div style="display:flex;gap:16px;align-items:center;">
          <button class="tab-header-btn active" id="tabDevicesBtn" onclick="switchAdminTab('devices')">ç»´ä¿®è®°å½•</button>
          <button class="tab-header-btn hidden" id="tabStaffBtn" onclick="switchAdminTab('staff')">äººå‘˜ç®¡ç†</button>
        </div>
        <p id="adminHeaderInfo"></p>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" style="font-size:0.82rem;padding:6px 14px;" id="btnAddDevice" onclick="openEditForm('add')">+ æ–°å¢è®°å½•</button>
        <button class="btn btn-secondary" style="font-size:0.78rem;padding:5px 10px;" id="btnColSettings" onclick="openColSettings()">åˆ—è®¾ç½®</button>
        <button class="btn btn-primary hidden" style="font-size:0.82rem;padding:6px 14px;" id="btnAddStaff" onclick="openStaffForm('add')">+ æ–°å¢äººå‘˜</button>
        <button class="icon-btn" id="adminChangePwdBtn" title="ä¿®æ”¹å¯†ç ">ğŸ”‘</button>
        <button class="icon-btn" id="adminLogoutBtn" title="é€€å‡ºç®¡ç†">â»</button>
      </div>
    </header>

    <!-- ç»´ä¿®è®°å½• Tab -->
    <div id="tabDevicesContent" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
    <div class="filter-bar">
      <div class="filter-item">
        <label>å®¢æˆ·ç¼–å·</label>
        <input type="text" class="form-input" id="filterCustomerId" placeholder="å®¢æˆ·ç¼–å·...">
      </div>
      <div class="filter-item">
        <label>åºåˆ—å·/MAC</label>
        <input type="text" class="form-input" id="filterSN" placeholder="è¾“å…¥æœç´¢...">
      </div>
      <div class="filter-item">
        <label>å‹å·</label>
        <select class="form-input" id="filterModel">
          <option value="">å…¨éƒ¨</option>
          <option value="__empty__">ï¼ˆç©ºï¼‰</option>
          <option value="L36">L36</option>
          <option value="TL58">TL58</option>
          <option value="L53i">L53i</option>
          <option value="TL54U">TL54U</option>
        </select>
      </div>
      <div class="filter-item">
        <label>ç»´ä¿®çŠ¶æ€</label>
        <select class="form-input" id="filterStatus">
          <option value="">å…¨éƒ¨</option>
          <option value="å·²æ”¶ä»¶">å·²æ”¶ä»¶</option>
          <option value="æœªæŠ¥ä»·">æœªæŠ¥ä»·</option>
          <option value="å·²æŠ¥ä»·">å·²æŠ¥ä»·</option>
          <option value="å¾…ç»´ä¿®">å¾…ç»´ä¿®</option>
          <option value="å¾…å‘è´§">å¾…å‘è´§</option>
          <option value="å·²å‘è´§">å·²å‘è´§</option>
        </select>
      </div>
      <div class="filter-item">
        <label>ç»´ä¿é€‰æ‹©</label>
        <select class="form-input" id="filterWarranty">
          <option value="">å…¨éƒ¨</option>
          <option value="__empty__">ï¼ˆç©ºï¼‰</option>
          <option value="æ–°æœºæ¢æ–°">æ–°æœºæ¢æ–°</option>
          <option value="ä¿å†…å…è´¹">ä¿å†…å…è´¹</option>
          <option value="ä¿å¤–æ”¶è´¹">ä¿å¤–æ”¶è´¹</option>
          <option value="ä»¥æ—§æ¢æ–°">ä»¥æ—§æ¢æ–°</option>
        </select>
      </div>
      <div class="filter-item">
        <label>å¿«é€’å•å·</label>
        <input type="text" class="form-input" id="filterTracking" placeholder="å¯„å›/å¯„å‡º...">
      </div>
      <div class="filter-item" style="justify-content:flex-end;">
        <label>&nbsp;</label>
        <button class="btn btn-secondary" style="font-size:0.8rem;padding:7px 12px;" onclick="clearFilters()">æ¸…ç©º</button>
      </div>
    </div>

    <div class="table-wrap" id="adminTableWrap">
      <table class="admin-table" id="adminTable">
        <thead>
          <tr></tr>
        </thead>
        <tbody id="adminTableBody"></tbody>
      </table>
    </div>

    <div class="admin-stats">
      <span id="adminStatsInfo">åŠ è½½ä¸­...</span>
      <div style="display:flex;align-items:center;gap:8px;">
        <button class="btn btn-secondary" style="font-size:0.75rem;padding:4px 8px;" onclick="changePage(-1)" id="prevPageBtn">ä¸Šä¸€é¡µ</button>
        <span id="pageInfo" style="font-size:0.78rem;white-space:nowrap;">1/1</span>
        <button class="btn btn-secondary" style="font-size:0.75rem;padding:4px 8px;" onclick="changePage(1)" id="nextPageBtn">ä¸‹ä¸€é¡µ</button>
        <select id="pageSizeSelect" style="font-size:0.75rem;padding:3px 6px;border:1px solid var(--border);border-radius:4px;" onchange="changePageSize()">
          <option value="20">20æ¡/é¡µ</option>
          <option value="50" selected>50æ¡/é¡µ</option>
          <option value="100">100æ¡/é¡µ</option>
          <option value="200">200æ¡/é¡µ</option>
        </select>
        <button class="btn btn-secondary" style="font-size:0.75rem;padding:4px 10px;" onclick="exportExcel()">å¯¼å‡ºExcel</button>
      </div>
    </div>
    </div><!-- /tabDevicesContent -->

    <!-- äººå‘˜ç®¡ç† Tab -->
    <div id="tabStaffContent" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="table-wrap">
        <table class="admin-table" id="staffTable">
          <thead>
            <tr>
              <th>å·¥å·</th>
              <th>å§“å</th>
              <th>è§’è‰²</th>
              <th>çŠ¶æ€</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="staffTableBody"></tbody>
        </table>
      </div>
      <div class="admin-stats">
        <span id="staffStatsInfo">åŠ è½½ä¸­...</span>
      </div>
    </div><!-- /tabStaffContent -->
  </div>

  <!-- åˆ—è®¾ç½®å¼¹çª— -->
  <div class="col-settings-overlay" id="colSettingsOverlay">
    <div class="col-settings-box">
      <h3>åˆ—æ˜¾ç¤ºè®¾ç½®</h3>
      <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:12px;">æ‹–æ‹½å¯è°ƒæ•´é¡ºåºï¼Œå–æ¶ˆå‹¾é€‰å¯éšè—åˆ—</p>
      <div id="colSettingsList"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
        <button class="btn btn-secondary" style="font-size:0.8rem;padding:6px 12px;" onclick="resetColSettings()">æ¢å¤é»˜è®¤</button>
        <button class="btn btn-primary" style="font-size:0.8rem;padding:6px 12px;" onclick="applyColSettings()">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç¼–è¾‘äººå‘˜å¼¹çª— -->
  <div class="modal-overlay" id="staffModal">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <h3 class="modal-title" id="staffModalTitle">æ–°å¢äººå‘˜</h3>
        <button class="modal-close" onclick="closeModal('staffModal')">&times;</button>
      </div>
      <form id="staffForm">
        <input type="hidden" id="staffEditMode" value="add">
        <input type="hidden" id="staffEditId" value="">
        <div class="form-group">
          <label class="form-label">å·¥å· *</label>
          <input type="text" class="form-input" id="staffUsername" placeholder="ç™»å½•å·¥å·" required>
        </div>
        <div class="form-group">
          <label class="form-label">å§“å</label>
          <input type="text" class="form-input" id="staffName" placeholder="å§“å">
        </div>
        <div class="form-group">
          <label class="form-label">å¯†ç  *</label>
          <input type="text" class="form-input" id="staffPassword" placeholder="ç™»å½•å¯†ç " required minlength="6">
        </div>
        <div class="form-group">
          <label class="form-label">è§’è‰²</label>
          <select class="form-input" id="staffRole">
            <option value="operator">æ“ä½œå‘˜</option>
            <option value="admin">ç®¡ç†å‘˜</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">çŠ¶æ€</label>
          <select class="form-input" id="staffActive">
            <option value="true">å¯ç”¨</option>
            <option value="false">ç¦ç”¨</option>
          </select>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('staffModal')">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ä¿®æ”¹æ—¥å¿—å¼¹çª— -->
  <div class="modal-overlay" id="logModal">
    <div class="modal" style="max-width:620px;">
      <div class="modal-header">
        <h3 class="modal-title" id="logModalTitle">ä¿®æ”¹æ—¥å¿—</h3>
        <button class="modal-close" onclick="closeModal('logModal')">&times;</button>
      </div>
      <div id="logModalContent" style="max-height:60vh;overflow-y:auto;">
        <p style="color:var(--text-muted);text-align:center;">åŠ è½½ä¸­...</p>
      </div>
    </div>
  </div>

  <!-- ä¿®æ”¹å¯†ç  -->
  <div class="modal-overlay" id="pwdModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title" id="pwdModalTitle">ä¿®æ”¹å¯†ç </h3>
        <button class="modal-close" onclick="closeModal('pwdModal')">&times;</button>
      </div>
      <form id="pwdForm">
        <div class="form-group">
          <label class="form-label">å½“å‰å¯†ç </label>
          <input type="password" class="form-input" id="oldPwd" required>
        </div>
        <div class="form-group">
          <label class="form-label">æ–°å¯†ç </label>
          <input type="password" class="form-input" id="newPwd" required minlength="6">
        </div>
        <div class="form-group">
          <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" class="form-input" id="confirmPwd" required>
        </div>
        <div class="error-msg" id="pwdError"></div>
        <div class="btn-row">
          <button type="submit" class="btn btn-primary">ç¡®è®¤ä¿®æ”¹</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('pwdModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- å…¨å±ç™»å½•é¡µ -->
  <div class="login-page" id="loginPage">
    <div class="login-bg">
      <div class="login-bg-circle c1"></div>
      <div class="login-bg-circle c2"></div>
      <div class="login-bg-circle c3"></div>
    </div>
    <div class="login-card">
      <div class="login-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="6" y="2" width="12" height="20" rx="2"/>
          <line x1="9" y1="18" x2="15" y2="18"/>
          <line x1="9" y1="6" x2="15" y2="6"/>
          <line x1="9" y1="10" x2="15" y2="10"/>
          <circle cx="12" cy="14" r="1"/>
        </svg>
      </div>
      <h2 class="login-title">æ‰“å°æœºç»´ä¿®ç®¡ç†åå°</h2>
      <p class="login-subtitle">è¯·è¾“å…¥å·¥å·å’Œå¯†ç ç™»å½•ç³»ç»Ÿ</p>
      <form id="adminLoginForm" class="login-form">
        <div class="login-field">
          <label class="login-label">å·¥å·</label>
          <div class="login-input-wrap">
            <svg class="login-input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <input type="text" class="login-input" id="adminUsername" placeholder="è¯·è¾“å…¥å·¥å·" required autocomplete="off">
          </div>
        </div>
        <div class="login-field">
          <label class="login-label">å¯†ç </label>
          <div class="login-input-wrap">
            <svg class="login-input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <input type="password" class="login-input" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç " required autocomplete="off">
          </div>
        </div>
        <div class="login-error" id="loginError"></div>
        <button type="submit" class="login-btn">
          <span class="login-btn-text">ç™» å½•</span>
          <svg class="login-btn-arrow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </button>
      </form>
      <p class="login-footer">Printer Repair Management System</p>
    </div>
  </div>

  <script>
    // ========== Supabase é…ç½® ==========
    const SUPABASE_URL = 'https://nthmtpvjucnqfypkgmoz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50aG10cHZqdWNucWZ5cGtnbW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MjMwMjAsImV4cCI6MjA4NTk5OTAyMH0.lG4oOIm2f8w6eglKxx-gGChK1yuEl_8ZgR98051qpNg';

    const supabase = {
      from(table) {
        return new SupabaseQuery(table);
      }
    };
    class SupabaseQuery {
      constructor(table) {
        this._table = table;
        this._method = 'GET';
        this._filters = [];
        this._selectFields = '*';
        this._orderStr = '';
        this._body = null;
        this._prefer = '';
      }
      select(fields) { this._method = 'GET'; if (fields) this._selectFields = fields; return this; }
      insert(rows) { this._method = 'POST'; this._body = rows; this._prefer = 'return=representation'; return this; }
      upsert(rows, { onConflict } = {}) { this._method = 'POST'; this._body = Array.isArray(rows) ? rows : [rows]; this._prefer = 'resolution=merge-duplicates,return=representation'; if (onConflict) this._filters.push(`on_conflict=${onConflict}`); return this; }
      update(data) { this._method = 'PATCH'; this._body = data; this._prefer = 'return=representation'; return this; }
      delete() { this._method = 'DELETE'; return this; }
      eq(field, value) { this._filters.push(`${field}=eq.${encodeURIComponent(value)}`); return this; }
      neq(field, value) { this._filters.push(`${field}=neq.${encodeURIComponent(value)}`); return this; }
      order(field, opts = {}) { this._orderStr = `order=${field}.${opts.ascending ? 'asc' : 'desc'}`; return this; }
      async _execute() {
        let url = `${SUPABASE_URL}/rest/v1/${this._table}`;
        const parts = [...this._filters];
        if (this._method === 'GET' && this._selectFields) parts.push(`select=${encodeURIComponent(this._selectFields)}`);
        if (this._orderStr) parts.push(this._orderStr);
        if (parts.length) url += '?' + parts.join('&');
        const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' };
        if (this._prefer) headers['Prefer'] = this._prefer;
        const fetchOpts = { method: this._method, headers };
        if (this._body) fetchOpts.body = JSON.stringify(this._body);
        try {
          const resp = await fetch(url, fetchOpts);
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            return { data: null, error: new Error(err.message || `HTTP ${resp.status}`) };
          }
          if (resp.status === 204) return { data: [], error: null };
          const data = await resp.json();
          return { data, error: null };
        } catch (err) {
          return { data: null, error: err };
        }
      }
      then(resolve, reject) { return this._execute().then(resolve, reject); }
    }

    const MODELS = ['L36', 'TL58', 'L53i', 'TL54U'];

    let devices = [];

    const REPAIR_PRICES = {
      'L36': {
        'æœºèŠ¯': { partFee: 180, laborFee: 100 },
        'å‹çº¸è½´': { partFee: 20, laborFee: 100 },
        'æŒ¡æ¿': { partFee: 0, laborFee: 100 },
        'çº¸ä»“ç›–æŒ‰é’®': { partFee: 0, laborFee: 100 },
        'å¤–å£³': { partFee: 50, laborFee: 100 },
        'ç”µæ± ': { partFee: 80, laborFee: 0 },
        'å……ç”µå™¨': { partFee: 30, laborFee: 0 },
      },
      'TL58': {
        'ä¸»æ¿': { partFee: 60, laborFee: 100 },
        'è“ç‰™æ¿': { partFee: 50, laborFee: 100 },
        'æœºèŠ¯': { partFee: 100, laborFee: 100 },
        'å‹çº¸è½´': { partFee: 10, laborFee: 100 },
        'å¤–å£³': { partFee: 50, laborFee: 100 },
        'å¼¹ç°§': { partFee: 0, laborFee: 0 },
        'å……ç”µå™¨': { partFee: 40, laborFee: 0 },
      },
      'L53i': {
        'ä¸»æ¿': { partFee: 180, laborFee: 100 },
        'æœºèŠ¯': { partFee: 280, laborFee: 100 },
        'å‹çº¸è½´': { partFee: 25, laborFee: 100 },
        'ç”µæ± ': { partFee: 90, laborFee: 0 },
        'å……ç”µå™¨': { partFee: 60, laborFee: 0 },
        'å¤–å£³': { partFee: 50, laborFee: 100 },
        'æŒ‰é”®æ¿(å«è“ç‰™æ¿)': { partFee: 120, laborFee: 100 },
      },
      'TL54U': {
        'ä¸»æ¿': { partFee: 180, laborFee: 100 },
        'æœºèŠ¯': { partFee: 280, laborFee: 100 },
        'çƒ­æ•æ¡': { partFee: 240, laborFee: 100 },
        'å……ç”µå™¨': { partFee: 60, laborFee: 0 },
        'æ»šè½´': { partFee: 25, laborFee: 100 },
        'è“ç‰™æ¿': { partFee: 50, laborFee: 100 },
        'å¤–å£³': { partFee: 80, laborFee: 100 },
        'ä¼ æ„Ÿæ¿': { partFee: 20, laborFee: 100 },
        'æŒ‰é”®æ¿': { partFee: 50, laborFee: 100 },
        'è½¬æ¥æ¿': { partFee: 50, laborFee: 100 },
      },
    };

    // ========== çŠ¶æ€ ==========
    let isAdmin = false;
    let currentUserRole = '';
    let currentUserId = null;
    let currentLoginName = '';
    let currentUsername = '';

    // ========== è®¾å¤‡æ•°æ®æ“ä½œ ==========
    function dbToDevice(d) {
      return {
        id: d.id,
        customerId: d.customer_id || '',
        model: d.model || '',
        sn: d.sn || '',
        mac: d.mac || '',
        purchaseDate: d.purchase_date || '',
        parts: d.parts || '',
        repairFee: d.repair_fee || '',
        returnTracking: d.return_tracking || '',
        sendTracking: d.send_tracking || '',
        returnAddress: d.return_address || '',
        warrantyType: d.warranty_type || '',
        registerDate: d.register_date || '',
        faultDesc: d.fault_desc || '',
        repairStatus: d.repair_status || 'å·²æ”¶ä»¶',
        remark: d.remark || ''
      };
    }

    function deviceToDb(device) {
      return {
        customer_id: device.customerId || '',
        model: device.model || '',
        sn: device.sn || null,
        mac: device.mac || null,
        purchase_date: device.purchaseDate || null,
        parts: device.parts || '',
        repair_fee: device.repairFee || '',
        return_tracking: device.returnTracking || '',
        send_tracking: device.sendTracking || '',
        return_address: device.returnAddress || '',
        warranty_type: device.warrantyType || '',
        register_date: device.registerDate || null,
        fault_desc: device.faultDesc || '',
        repair_status: device.repairStatus || 'å·²æ”¶ä»¶',
        remark: device.remark || ''
      };
    }

    async function loadDevicesFromCloud() {
      const res = await supabase.from('devices').select('*').order('id', { ascending: false });
      if (res.error) throw res.error;
      devices = (res.data || []).map(dbToDevice);
      console.log(`å·²ä»äº‘ç«¯åŠ è½½ ${devices.length} æ¡è®¾å¤‡æ•°æ®`);
      return devices;
    }

    // å­—æ®µä¸­æ–‡åæ˜ å°„
    const FIELD_LABELS = {
      customerId: 'å®¢æˆ·ç¼–å·', model: 'å‹å·', sn: 'åºåˆ—å·', mac: 'MACåœ°å€',
      purchaseDate: 'è´­ä¹°æ—¥æœŸ', parts: 'éœ€æ›´æ¢é…ä»¶', repairFee: 'éœ€ä»˜è´¹',
      warrantyType: 'ç»´ä¿é€‰æ‹©', repairStatus: 'ç»´ä¿®çŠ¶æ€', registerDate: 'ç™»è®°æ—¥æœŸ',
      returnTracking: 'å¯„å›å¿«é€’', sendTracking: 'å¯„å‡ºå¿«é€’', returnAddress: 'å¯„å›åœ°å€', faultDesc: 'æ•…éšœæè¿°', remark: 'å¤‡æ³¨'
    };

    function diffDevice(oldD, newD) {
      const changes = [];
      for (const key of Object.keys(FIELD_LABELS)) {
        const o = (oldD[key] || '').toString().trim();
        const n = (newD[key] || '').toString().trim();
        if (o !== n) {
          changes.push(`${FIELD_LABELS[key]}ï¼šã€Œ${o || 'ç©º'}ã€â†’ã€Œ${n || 'ç©º'}ã€`);
        }
      }
      return changes;
    }

    async function saveDeviceLog(deviceId, action, changes) {
      try {
        await supabase.from('device_logs').insert([{
          device_id: deviceId,
          operator: currentLoginName || '',
          operator_name: currentUsername || '',
          action: action,
          changes: changes
        }]);
      } catch (e) {
        console.warn('æ—¥å¿—è®°å½•å¤±è´¥:', e);
      }
    }

    async function saveDevice(device, isEdit) {
      try {
        const row = deviceToDb(device);
        let res;
        let oldDevice = null;
        if (isEdit && device.id) {
          oldDevice = devices.find(d => d.id === device.id);
          res = await supabase.from('devices').update(row).eq('id', device.id);
        } else {
          res = await supabase.from('devices').insert([row]);
        }
        if (res.error) throw res.error;

        // è®°å½•æ—¥å¿—
        if (isEdit && oldDevice) {
          const changes = diffDevice(oldDevice, device);
          if (changes.length > 0) {
            await saveDeviceLog(device.id, 'edit', changes.join('\n'));
          }
        } else if (!isEdit && res.data && res.data[0]) {
          const now = new Date().toLocaleString('zh-CN');
          const summary = [
            device.customerId ? `å®¢æˆ·ç¼–å·ï¼š${device.customerId}` : '',
            device.model ? `å‹å·ï¼š${device.model}` : '',
            device.sn ? `åºåˆ—å·ï¼š${device.sn}` : '',
            device.mac ? `MACï¼š${device.mac}` : '',
            device.parts ? `é…ä»¶ï¼š${device.parts}` : '',
            device.repairStatus ? `çŠ¶æ€ï¼š${device.repairStatus}` : ''
          ].filter(Boolean).join('\n');
          await saveDeviceLog(res.data[0].id, 'add', `æ–°å¢æ—¶é—´ï¼š${now}\n${summary}`);
        }

        await loadDevicesFromCloud();
        return true;
      } catch (err) {
        console.error('ä¿å­˜è®¾å¤‡å¤±è´¥:', err);
        alert('ä¿å­˜å¤±è´¥: ' + err.message);
        return false;
      }
    }

    async function addDevice(device) { return saveDevice(device); }

    function getDevice(snOrMac) {
      const trimmed = snOrMac.replace(/\s/g, '');
      const normalized = snOrMac.replace(/[\s\-:]/g, '').toUpperCase();
      return devices.find(d =>
        d.sn === trimmed ||
        d.sn === normalized ||
        d.mac.replace(/[\s\-:]/g, '').toUpperCase() === normalized ||
        (d.customerId && d.customerId.toUpperCase() === normalized)
      ) || null;
    }

    function getDevicesByCustomerId(customerId) {
      const cid = customerId.trim().toUpperCase();
      return devices.filter(d => d.customerId && d.customerId.toUpperCase() === cid);
    }

    function getAllDevices() {
      return devices;
    }

    async function deleteDevice(id) {
      try {
        const device = devices.find(d => d.id === id);
        const res = await supabase.from('devices').delete().eq('id', id);
        if (res.error) throw res.error;
        // è®°å½•åˆ é™¤æ—¥å¿—
        if (device) {
          await saveDeviceLog(id, 'delete', `åˆ é™¤è®°å½•ï¼šSN=${device.sn || 'ç©º'}, å‹å·=${device.model || 'ç©º'}, å®¢æˆ·=${device.customerId || 'ç©º'}`);
        }
        const idx = devices.findIndex(d => d.id === id);
        if (idx >= 0) devices.splice(idx, 1);
        return true;
      } catch (err) {
        console.error('åˆ é™¤å¤±è´¥:', err);
        alert('åˆ é™¤å¤±è´¥: ' + err.message);
        return false;
      }
    }

    // ========== ç™»å½•/æƒé™ ==========
    function showLoginPage() {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('adminPanel').classList.remove('show');
    }
    function hideLoginPage() {
      document.getElementById('loginPage').classList.add('hidden');
    }

    function updateAdminUI() {
      if (isAdmin) {
        hideLoginPage();
        document.getElementById('adminPanel').classList.add('show');
        if (currentUserRole === 'admin') {
          document.getElementById('tabStaffBtn').classList.remove('hidden');
        } else {
          document.getElementById('tabStaffBtn').classList.add('hidden');
          switchAdminTab('devices');
        }
        document.getElementById('adminHeaderInfo').textContent =
          currentUserRole === 'admin' ? 'ç®¡ç†å‘˜æ¨¡å¼' : 'æ“ä½œå‘˜ï¼š' + (currentUsername || '');
        refreshAdminTable();
      } else {
        document.getElementById('adminPanel').classList.remove('show');
        showLoginPage();
      }
    }

    function switchAdminTab(tab) {
      const devicesBtn = document.getElementById('tabDevicesBtn');
      const staffBtn = document.getElementById('tabStaffBtn');
      const devicesContent = document.getElementById('tabDevicesContent');
      const staffContent = document.getElementById('tabStaffContent');
      const btnAddDevice = document.getElementById('btnAddDevice');
      const btnAddStaff = document.getElementById('btnAddStaff');
      const btnColSettings = document.getElementById('btnColSettings');
      if (tab === 'staff') {
        devicesBtn.classList.remove('active');
        staffBtn.classList.add('active');
        devicesContent.style.display = 'none';
        staffContent.style.display = 'flex';
        btnAddDevice.classList.add('hidden');
        btnColSettings.classList.add('hidden');
        btnAddStaff.classList.remove('hidden');
        refreshStaffTable();
      } else {
        staffBtn.classList.remove('active');
        devicesBtn.classList.add('active');
        staffContent.style.display = 'none';
        devicesContent.style.display = 'flex';
        btnAddStaff.classList.add('hidden');
        btnAddDevice.classList.remove('hidden');
        btnColSettings.classList.remove('hidden');
      }
    }

    // ========== å·¥å…·ï¼ˆè´¹ç”¨è®¡ç®—ç­‰ï¼‰ ==========
    function parseDate(dateStr) {
      if (!dateStr) return null;
      let d = new Date(dateStr);
      if (!isNaN(d)) return d;
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        let year = parseInt(parts[0], 10);
        if (year < 100) year += 2000;
        return new Date(year, parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
      }
      return null;
    }

    function daysBetween(d1, d2) {
      return Math.floor(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
    }

    function getWarrantyStatus(device) {
      const purchaseDate = parseDate(device.purchaseDate);
      if (!purchaseDate) return 'outOfWarranty';
      const days = daysBetween(purchaseDate, new Date());
      if (days <= 15) return 'new';
      if (days <= 365) return 'inWarranty';
      return 'outOfWarranty';
    }

    const PART_SYNONYMS = {
      'ä¸»æ§æ¿': 'ä¸»æ¿',
      'ä¸»æ§åˆ¶æ¿': 'ä¸»æ¿',
      'å¡æ‰£': 'æŒ¡æ¿',
      'é”‚ç”µæ± ': 'ç”µæ± ',
      'çƒ­æ•å¤´': 'çƒ­æ•æ¡',
      'ç”µæºé€‚é…å™¨': 'å……ç”µå™¨',
      'TL54ä¼ æ„Ÿæ¿': 'ä¼ æ„Ÿæ¿',
      'TL54æŒ‰é”®æ¿': 'æŒ‰é”®æ¿',
      'TL54è½¬æ¥æ¿': 'è½¬æ¥æ¿',
      'TL58ç”µæºé€‚é…å™¨': 'å……ç”µå™¨',
      'TL58è“ç‰™ç‰ˆ': 'è“ç‰™æ¿',
      'TL58è“ç‰™æ¿': 'è“ç‰™æ¿'
    };

    const COMPOUND_PARTS = {
      'ä¸»æ§æ¿ç”µæºé€‚é…å™¨': ['ä¸»æ¿', 'å……ç”µå™¨']
    };

    function normalizePart(partName) {
      partName = partName.trim();
      if (COMPOUND_PARTS[partName]) return COMPOUND_PARTS[partName];
      if (PART_SYNONYMS[partName]) return [PART_SYNONYMS[partName]];
      return [partName];
    }

    function isFirmwareOnly(partsStr) {
      if (!partsStr) return false;
      const parts = partsStr.split(/[;ï¼›]/).map(p => p.trim()).filter(Boolean);
      return parts.length === 1 && parts[0] === 'å›ºä»¶';
    }

    function calcRepairPrice(model, partsStr) {
      const modelPrices = REPAIR_PRICES[model];
      if (!modelPrices) return null;

      const rawParts = partsStr ? partsStr.split(/[;ï¼›]/).map(p => p.trim()).filter(Boolean) : [];
      if (rawParts.length === 0) return null;

      const normalizedParts = [];
      rawParts.forEach(partName => {
        if (partName === 'å›ºä»¶') return;
        const normalized = normalizePart(partName);
        normalizedParts.push(...normalized);
      });

      if (normalizedParts.length === 0) return null;

      const uniqueParts = [...new Set(normalizedParts)];

      let totalPartFee = 0;
      let maxLaborFee = 0;
      const details = [];

      uniqueParts.forEach(partName => {
        let matched = null;
        for (const [name, price] of Object.entries(modelPrices)) {
          if (name === partName || name.includes(partName) || partName.includes(name)) {
            matched = { name, ...price };
            break;
          }
        }
        if (matched) {
          totalPartFee += matched.partFee;
          if (matched.laborFee > maxLaborFee) maxLaborFee = matched.laborFee;
          details.push({ name: matched.name, partFee: matched.partFee, laborFee: matched.laborFee });
        }
      });

      const totalFee = totalPartFee + maxLaborFee;
      return { details, totalPartFee, laborFee: maxLaborFee, totalFee };
    }

    // ========== æ¨¡æ€æ¡† ==========
    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    // ========== æ–°å¢/ç¼–è¾‘è¡¨å• ==========
    function renderPartsSelect(model, selectedParts) {
      const dropdown = document.getElementById('editPartsDropdown');
      const modelPrices = REPAIR_PRICES[model] || {};
      const partNames = Object.keys(modelPrices);
      const allParts = [...partNames, 'å›ºä»¶'];
      const selected = selectedParts ? selectedParts.split(/[;ï¼›]/).map(p => p.trim()).filter(Boolean) : [];

      dropdown.innerHTML = allParts.map(name => {
        const isChecked = selected.some(s => {
          const normalized = normalizePart(s);
          return normalized.includes(name) || s === name;
        }) || selected.includes(name);
        return `<label class="multi-select-option">
          <input type="checkbox" value="${name}" ${isChecked ? 'checked' : ''} onchange="updatePartsAndFee()">
          <span>${name}</span>
        </label>`;
      }).join('');

      updatePartsAndFee();
    }

    function togglePartsDropdown() {
      const display = document.getElementById('editPartsDisplay');
      const dropdown = document.getElementById('editPartsDropdown');
      const isOpen = dropdown.classList.contains('open');
      dropdown.classList.toggle('open', !isOpen);
      display.classList.toggle('open', !isOpen);
    }

    document.addEventListener('click', function(e) {
      const multi = document.getElementById('editPartsMulti');
      if (multi && !multi.contains(e.target)) {
        document.getElementById('editPartsDropdown').classList.remove('open');
        document.getElementById('editPartsDisplay').classList.remove('open');
      }
    });

    function updatePartsAndFee() {
      const checkboxes = document.querySelectorAll('#editPartsDropdown input:checked');
      const parts = Array.from(checkboxes).map(cb => cb.value);
      document.getElementById('editParts').value = parts.join(';');

      const display = document.getElementById('editPartsDisplay');
      if (parts.length === 0) {
        display.innerHTML = '<span class="multi-select-placeholder">è¯·é€‰æ‹©é…ä»¶...</span>';
      } else {
        display.innerHTML = parts.map(p => `<span class="multi-select-tag">${p}</span>`).join('');
      }

      const model = document.getElementById('editModel').value;
      const warrantyType = document.getElementById('editWarrantyType').value;
      const feeEl = document.getElementById('editFeeDisplay');

      if (parts.length === 0) {
        feeEl.innerHTML = '<span style="color:var(--text-muted);">-</span>';
        return;
      }
      if (parts.length === 1 && parts[0] === 'å›ºä»¶') {
        feeEl.innerHTML = '<span style="color:var(--success);">æ— éœ€æ”¶è´¹ï¼ˆä»…å›ºä»¶å‡çº§ï¼‰</span>';
        return;
      }
      if (warrantyType === 'æ–°æœºæ¢æ–°') {
        feeEl.innerHTML = '<span style="color:var(--success);">æ— éœ€æ”¶è´¹ï¼ˆæ–°æœºæ¢æ–°ï¼‰</span>';
        return;
      }
      if (warrantyType === 'ä¿å†…å…è´¹') {
        feeEl.innerHTML = '<span style="color:var(--success);">æ— éœ€æ”¶è´¹ï¼ˆä¿å†…å…è´¹ï¼‰</span>';
        return;
      }

      const priceInfo = calcRepairPrice(model, parts.join(';'));
      if (priceInfo && priceInfo.details.length > 0) {
        let html = priceInfo.details.map(d => `${d.name} Â¥${d.partFee}`).join(' + ');
        html += ` + äººå·¥ Â¥${priceInfo.laborFee}`;
        html += ` = <span style="color:var(--danger);font-size:1rem;">Â¥${priceInfo.totalFee}</span>`;
        feeEl.innerHTML = html;
      } else {
        feeEl.innerHTML = '<span style="color:var(--text-muted);">æ— æ³•è®¡ç®—ï¼ˆé…ä»¶ä¸åœ¨ä»·æ ¼è¡¨ä¸­ï¼‰</span>';
      }
    }

    function openEditForm(mode, id) {
      const form = document.getElementById('editForm');
      form.reset();
      document.getElementById('editMode').value = mode;

      document.getElementById('editId').value = '';
      if (mode === 'edit' && id) {
        const d = devices.find(dev => dev.id === id);
        if (!d) return;
        document.getElementById('editModalTitle').textContent = 'ç¼–è¾‘ç»´ä¿®è®°å½•';
        document.getElementById('editSubmitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
        document.getElementById('editId').value = d.id || '';
        document.getElementById('editCustomerId').value = d.customerId || '';
        document.getElementById('editSN').value = d.sn;
        document.getElementById('editModel').value = d.model;
        document.getElementById('editMAC').value = d.mac;
        document.getElementById('editPurchaseDate').value = d.purchaseDate || '';
        document.getElementById('editWarrantyType').value = d.warrantyType || '';
        document.getElementById('editRepairStatus').value = d.repairStatus || 'å·²æ”¶ä»¶';
        document.getElementById('editRegisterDate').value = d.registerDate || '';
        document.getElementById('editReturnTracking').value = d.returnTracking || '';
        document.getElementById('editSendTracking').value = d.sendTracking || '';
        document.getElementById('editReturnAddress').value = d.returnAddress || '';
        document.getElementById('editFaultDesc').value = d.faultDesc || '';
        document.getElementById('editRemark').value = d.remark || '';
        renderPartsSelect(d.model, d.parts);
      } else {
        document.getElementById('editModalTitle').textContent = 'æ–°å¢ç»´ä¿®è®°å½•';
        document.getElementById('editSubmitBtn').textContent = 'æ·»åŠ ';
        document.getElementById('editRegisterDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('editPurchaseDate').value = '';
        renderPartsSelect(document.getElementById('editModel').value, '');
      }
      openModal('editModal');
      // ä»…æ–°å¢æ—¶è‡ªåŠ¨è®¡ç®—ç»´ä¿é€‰æ‹©ï¼Œç¼–è¾‘æ—¶ä¿ç•™å·²æœ‰çš„ç»´ä¿é€‰æ‹©
      if (mode !== 'edit') {
        document.getElementById('editPurchaseDate').dispatchEvent(new Event('change'));
      } else {
        updatePartsAndFee();
      }
    }

    document.getElementById('editModel').addEventListener('change', function() {
      renderPartsSelect(this.value, document.getElementById('editParts').value);
    });

    document.getElementById('editWarrantyType').addEventListener('change', updatePartsAndFee);

    function calcRepairFeeForSave() {
      const model = document.getElementById('editModel').value;
      const parts = document.getElementById('editParts').value.trim();
      const warrantyType = document.getElementById('editWarrantyType').value;
      if (!parts) return '';
      if (parts === 'å›ºä»¶') return '0';
      if (warrantyType === 'æ–°æœºæ¢æ–°' || warrantyType === 'ä¿å†…å…è´¹') return '0';
      const priceInfo = calcRepairPrice(model, parts);
      if (priceInfo && priceInfo.totalFee > 0) return String(priceInfo.totalFee);
      return '';
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('editId').value;
      const device = {
        id: editId ? parseInt(editId) : null,
        customerId: document.getElementById('editCustomerId').value.trim(),
        model: document.getElementById('editModel').value,
        sn: document.getElementById('editSN').value.trim(),
        mac: document.getElementById('editMAC').value.trim().toUpperCase(),
        purchaseDate: document.getElementById('editPurchaseDate').value,
        parts: document.getElementById('editParts').value.trim(),
        repairFee: calcRepairFeeForSave(),
        warrantyType: document.getElementById('editWarrantyType').value,
        repairStatus: document.getElementById('editRepairStatus').value,
        registerDate: document.getElementById('editRegisterDate').value,
        returnTracking: document.getElementById('editReturnTracking').value.trim(),
        sendTracking: document.getElementById('editSendTracking').value.trim(),
        returnAddress: document.getElementById('editReturnAddress').value.trim(),
        faultDesc: document.getElementById('editFaultDesc').value.trim(),
        remark: document.getElementById('editRemark').value.trim()
      };

      const mode = document.getElementById('editMode').value;
      const ok = await saveDevice(device, mode === 'edit');
      if (ok) {
        closeModal('editModal');
        if (document.getElementById('adminPanel').classList.contains('show')) {
          refreshAdminTable();
        }
      }
    });

    // æ—¥æœŸæ™ºèƒ½è¯†åˆ«ï¼šæ”¯æŒç²˜è´´å„ç§æ ¼å¼è‡ªåŠ¨è½¬æ¢
    function smartParseDate(str) {
      if (!str) return '';
      str = str.trim().replace(/[å¹´æœˆ]/g, '-').replace(/[æ—¥å·]/g, '').replace(/\//g, '-').replace(/\./g, '-');
      // å¤„ç† 26-02-05 è¿™ç§çŸ­æ ¼å¼
      let parts = str.split('-');
      if (parts.length === 3) {
        let y = parseInt(parts[0], 10), m = parseInt(parts[1], 10), d = parseInt(parts[2], 10);
        if (y < 100) y += 2000;
        if (m >= 1 && m <= 12 && d >= 1 && d <= 31) {
          return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
      }
      // å¤„ç† 20260205 è¿™ç§çº¯æ•°å­—
      if (/^\d{8}$/.test(str)) {
        return `${str.slice(0,4)}-${str.slice(4,6)}-${str.slice(6,8)}`;
      }
      // å°è¯•æ ‡å‡†è§£æ
      const d = new Date(str);
      if (!isNaN(d)) return d.toISOString().split('T')[0];
      return '';
    }

    function bindDateSmartInput(inputId) {
      const el = document.getElementById(inputId);
      // ç²˜è´´äº‹ä»¶
      el.addEventListener('paste', (e) => {
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const parsed = smartParseDate(text);
        if (parsed) {
          e.preventDefault();
          el.value = parsed;
          el.dispatchEvent(new Event('change'));
        }
      });
      // æ‰‹åŠ¨è¾“å…¥æˆ–å¤±ç„¦æ—¶è‡ªåŠ¨è§£æ
      el.addEventListener('blur', () => {
        const v = el.value;
        if (v && !/^\d{4}-\d{2}-\d{2}$/.test(v)) {
          const parsed = smartParseDate(v);
          if (parsed) {
            el.value = parsed;
            el.dispatchEvent(new Event('change'));
          }
        }
      });
      // input äº‹ä»¶ï¼ˆå¤„ç†ç›´æ¥è¾“å…¥æˆ–ç²˜è´´åï¼‰
      el.addEventListener('input', () => {
        const v = el.value;
        // å¦‚æœç”¨æˆ·ç²˜è´´äº†éæ ‡å‡†æ ¼å¼ä¸”é•¿åº¦è¶³å¤Ÿï¼Œå°è¯•è§£æ
        if (v && v.length >= 6 && !/^\d{4}-\d{2}-\d{2}$/.test(v)) {
          const parsed = smartParseDate(v);
          if (parsed) {
            el.value = parsed;
            el.dispatchEvent(new Event('change'));
          }
        }
      });
    }
    bindDateSmartInput('editPurchaseDate');
    bindDateSmartInput('editRegisterDate');

    document.getElementById('editPurchaseDate').addEventListener('change', (e) => {
      const dateStr = e.target.value;
      if (!dateStr) return;
      const purchaseDate = new Date(dateStr);
      const now = new Date();
      const days = Math.floor((now - purchaseDate) / (1000 * 60 * 60 * 24));
      const warrantySelect = document.getElementById('editWarrantyType');
      if (days <= 15) {
        warrantySelect.value = 'æ–°æœºæ¢æ–°';
      } else if (days <= 365) {
        warrantySelect.value = 'ä¿å†…å…è´¹';
      } else {
        warrantySelect.value = 'ä¿å¤–æ”¶è´¹';
      }
      updatePartsAndFee();
    });

    // ========== ç®¡ç†é¢æ¿è¡¨æ ¼ ==========
    function getFilteredDevices() {
      let filtered = getAllDevices();
      const customerIdFilter = (document.getElementById('filterCustomerId').value || '').trim().toUpperCase();
      const snFilter = (document.getElementById('filterSN').value || '').trim().toUpperCase();
      const modelFilter = document.getElementById('filterModel').value;
      const statusFilter = document.getElementById('filterStatus').value;
      const warrantyFilter = document.getElementById('filterWarranty').value;
      const trackingFilter = (document.getElementById('filterTracking').value || '').trim().toUpperCase();

      if (customerIdFilter) {
        filtered = filtered.filter(d => (d.customerId || '').toUpperCase().includes(customerIdFilter));
      }
      if (snFilter) {
        filtered = filtered.filter(d =>
          d.sn.toUpperCase().includes(snFilter) ||
          d.mac.replace(/[\s\-:]/g, '').toUpperCase().includes(snFilter.replace(/[\s\-:]/g, ''))
        );
      }
      if (modelFilter === '__empty__') { filtered = filtered.filter(d => !d.model); }
      else if (modelFilter) { filtered = filtered.filter(d => d.model === modelFilter); }
      if (statusFilter) { filtered = filtered.filter(d => d.repairStatus === statusFilter); }
      if (warrantyFilter === '__empty__') { filtered = filtered.filter(d => !d.warrantyType); }
      else if (warrantyFilter) { filtered = filtered.filter(d => d.warrantyType === warrantyFilter); }
      if (trackingFilter) {
        filtered = filtered.filter(d =>
          (d.returnTracking && d.returnTracking.toUpperCase().includes(trackingFilter)) ||
          (d.sendTracking && d.sendTracking.toUpperCase().includes(trackingFilter))
        );
      }
      return filtered;
    }

    const ALL_COLUMNS = [
      { key: 'customerId', label: 'å®¢æˆ·ç¼–å·', visible: true },
      { key: 'model', label: 'å‹å·', visible: true },
      { key: 'sn', label: 'åºåˆ—å·', visible: true },
      { key: 'mac', label: 'MACåœ°å€', visible: true },
      { key: 'purchaseDate', label: 'è´­ä¹°æ—¥æœŸ', visible: true },
      { key: 'warrantyType', label: 'ç»´ä¿é€‰æ‹©', visible: true },
      { key: 'parts', label: 'éœ€æ›´æ¢é…ä»¶', visible: true },
      { key: 'repairFee', label: 'éœ€ä»˜è´¹', visible: true },
      { key: 'faultDesc', label: 'æ•…éšœæè¿°', visible: true },
      { key: 'repairStatus', label: 'ç»´ä¿®çŠ¶æ€', visible: true },
      { key: 'registerDate', label: 'ç™»è®°æ—¥æœŸ', visible: true },
      { key: 'returnTracking', label: 'å¯„å›å¿«é€’', visible: false },
      { key: 'sendTracking', label: 'å¯„å‡ºå¿«é€’', visible: false },
      { key: 'returnAddress', label: 'å¯„å›åœ°å€', visible: false },
      { key: 'remark', label: 'å¤‡æ³¨', visible: false },
    ];

    function getColumnConfig() {
      try {
        const saved = localStorage.getItem('col_config');
        if (saved) {
          const config = JSON.parse(saved);
          const existingKeys = config.map(c => c.key);
          ALL_COLUMNS.forEach(col => {
            if (!existingKeys.includes(col.key)) config.push({ ...col });
          });
          return config;
        }
      } catch(e) {}
      return ALL_COLUMNS.map(c => ({ ...c }));
    }

    function saveColumnConfig(config) {
      localStorage.setItem('col_config', JSON.stringify(config));
    }

    let columnConfig = getColumnConfig();

    function getVisibleColumns() {
      return columnConfig.filter(c => c.visible);
    }

    function renderCellValue(d, key) {
      switch(key) {
        case 'sn': return `<span class="sn-cell">${d.sn}</span>`;
        case 'warrantyType': return d.warrantyType ? `<span class="status-badge ${d.warrantyType}">${d.warrantyType}</span>` : '-';
        case 'repairFee': return d.repairFee ? `<span style="color:var(--danger);font-weight:600;">Â¥${d.repairFee}</span>` : '-';
        case 'repairStatus': return `<span class="status-badge ${d.repairStatus || 'å·²æ”¶ä»¶'}">${d.repairStatus || 'å·²æ”¶ä»¶'}</span>`;
        case 'faultDesc': return `<span style="max-width:150px;display:inline-block;overflow:hidden;text-overflow:ellipsis;" title="${(d[key]||'').replace(/"/g,'&quot;')}">${d[key] || '-'}</span>`;
        case 'remark': return `<span style="max-width:120px;display:inline-block;overflow:hidden;text-overflow:ellipsis;" title="${(d[key]||'').replace(/"/g,'&quot;')}">${d[key] || '-'}</span>`;
        default: return d[key] || '-';
      }
    }

    let expandedRows = new Set();
    let currentPage = 1;
    let pageSize = 50;

    function changePage(delta) {
      const filtered = getFilteredDevices();
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
      refreshAdminTable();
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      currentPage = 1;
      refreshAdminTable();
    }

    function toggleExpandRow(id) {
      if (expandedRows.has(id)) expandedRows.delete(id);
      else expandedRows.add(id);
      refreshAdminTable();
    }

    async function openDeviceLog(deviceId) {
      const content = document.getElementById('logModalContent');
      const device = devices.find(d => d.id === deviceId);
      const title = device ? `ä¿®æ”¹æ—¥å¿— - ${device.sn || device.customerId || 'ID:' + deviceId}` : 'ä¿®æ”¹æ—¥å¿—';
      document.getElementById('logModalTitle').textContent = title;
      content.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">åŠ è½½ä¸­...</p>';
      openModal('logModal');

      try {
        const res = await supabase.from('device_logs').select('*').eq('device_id', deviceId).order('created_at', { ascending: false });
        if (res.error) throw res.error;
        const logs = res.data || [];
        if (logs.length === 0) {
          content.innerHTML = '<div class="log-empty">æš‚æ— ä¿®æ”¹è®°å½•</div>';
          return;
        }
        content.innerHTML = logs.map(log => {
          const actionMap = { add: 'æ–°å¢', edit: 'ä¿®æ”¹', delete: 'åˆ é™¤' };
          const actionText = actionMap[log.action] || log.action;
          const time = new Date(log.created_at).toLocaleString('zh-CN');
          const operator = log.operator_name || log.operator || 'æœªçŸ¥';
          return `<div class="log-entry log-${log.action}">
            <div class="log-header">
              <span><span class="log-action">${actionText}</span> æ“ä½œäººï¼š${operator}</span>
              <span>${time}</span>
            </div>
            <div class="log-changes">${log.changes || '-'}</div>
          </div>`;
        }).join('');
      } catch (err) {
        content.innerHTML = `<p style="color:var(--danger);text-align:center;padding:20px;">åŠ è½½å¤±è´¥ï¼š${err.message || 'ç½‘ç»œé”™è¯¯'}</p>`;
      }
    }

    function renderExpandContent(d) {
      const allFields = [
        { label: 'å®¢æˆ·ç¼–å·', value: d.customerId },
        { label: 'å‹å·', value: d.model },
        { label: 'åºåˆ—å·', value: d.sn },
        { label: 'MACåœ°å€', value: d.mac },
        { label: 'è´­ä¹°æ—¥æœŸ', value: d.purchaseDate },
        { label: 'ç»´ä¿é€‰æ‹©', value: d.warrantyType },
        { label: 'éœ€æ›´æ¢é…ä»¶', value: d.parts },
        { label: 'éœ€ä»˜è´¹', value: d.repairFee ? 'Â¥' + d.repairFee : '' },
        { label: 'æ•…éšœæè¿°', value: d.faultDesc },
        { label: 'ç»´ä¿®çŠ¶æ€', value: d.repairStatus },
        { label: 'ç™»è®°æ—¥æœŸ', value: d.registerDate },
        { label: 'å¯„å›å¿«é€’', value: d.returnTracking },
        { label: 'å¯„å‡ºå¿«é€’', value: d.sendTracking },
        { label: 'å¯„å›åœ°å€', value: d.returnAddress },
        { label: 'å¤‡æ³¨', value: d.remark },
      ];
      const longFields = ['éœ€æ›´æ¢é…ä»¶', 'æ•…éšœæè¿°', 'å¯„å›åœ°å€', 'å¤‡æ³¨'];
      return `<div class="expand-content">${allFields.map(f => {
        const isLong = longFields.includes(f.label) && f.value && f.value.length > 20;
        return `<div class="expand-item${isLong ? ' expand-item-full' : ''}"><span class="expand-label">${f.label}ï¼š</span><span class="expand-value">${f.value || '-'}</span></div>`;
      }).join('')}</div>`;
    }

    function refreshAdminTable() {
      const allDevices = getAllDevices();
      const filtered = getFilteredDevices();
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const showing = filtered.slice(start, start + pageSize);
      const visCols = getVisibleColumns();

      document.getElementById('adminStatsInfo').innerHTML =
        `æ€»è®¡ <strong>${allDevices.length}</strong> æ¡` +
        (filtered.length !== allDevices.length ? `ï¼Œç­›é€‰ <strong>${filtered.length}</strong> æ¡` : '');

      document.getElementById('pageInfo').textContent = `${currentPage}/${totalPages}`;
      document.getElementById('prevPageBtn').disabled = currentPage <= 1;
      document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;

      const thead = document.querySelector('#adminTable thead tr');
      thead.innerHTML = visCols.map(c => `<th>${c.label}<div class="col-resizer"></div></th>`).join('') + '<th>æ“ä½œ</th>';

      document.getElementById('adminTableBody').innerHTML = showing.map(d => {
        const isExpanded = expandedRows.has(d.id);
        let row = `<tr>
          ${visCols.map(c => `<td>${renderCellValue(d, c.key)}</td>`).join('')}
          <td>
            <div class="action-btns">
              <span class="expand-toggle" onclick="toggleExpandRow(${d.id})">${isExpanded ? 'â–² æ”¶èµ·' : 'â–¼ å±•å¼€'}</span>
              <button class="action-btn" onclick="openEditForm('edit',${d.id})">ç¼–è¾‘</button>
              <button class="action-btn" onclick="openDeviceLog(${d.id})" style="color:var(--warning);">æ—¥å¿—</button>
              <button class="action-btn del" onclick="deleteDeviceUI(${d.id})">åˆ é™¤</button>
            </div>
          </td>
        </tr>`;
        if (isExpanded) {
          row += `<tr class="expand-row"><td colspan="${visCols.length + 1}">${renderExpandContent(d)}</td></tr>`;
        }
        return row;
      }).join('');
      setTimeout(applyColWidths, 0);
    }

    function clearFilters() {
      document.getElementById('filterCustomerId').value = '';
      document.getElementById('filterSN').value = '';
      document.getElementById('filterModel').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterWarranty').value = '';
      document.getElementById('filterTracking').value = '';
      currentPage = 1;
      refreshAdminTable();
    }

    ['filterCustomerId', 'filterSN', 'filterTracking'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => { currentPage = 1; refreshAdminTable(); });
    });
    ['filterModel', 'filterStatus', 'filterWarranty'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => { currentPage = 1; refreshAdminTable(); });
    });

    window.deleteDeviceUI = async function(id) {
      if (confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ')) {
        const ok = await deleteDevice(id);
        if (ok) refreshAdminTable();
      }
    };

    // ========== åˆ—è®¾ç½®å¼¹çª— ==========
    let tempColConfig = [];
    let dragIdx = null;

    function openColSettings() {
      tempColConfig = columnConfig.map(c => ({ ...c }));
      renderColSettingsList();
      document.getElementById('colSettingsOverlay').classList.add('show');
    }

    function renderColSettingsList() {
      const list = document.getElementById('colSettingsList');
      list.innerHTML = tempColConfig.map((c, i) => `
        <div class="col-item" draggable="true" data-idx="${i}"
          ondragstart="colDragStart(event,${i})" ondragover="colDragOver(event)" ondrop="colDrop(event,${i})">
          <span style="cursor:grab;color:var(--text-muted);">â˜°</span>
          <input type="checkbox" ${c.visible ? 'checked' : ''} onchange="tempColConfig[${i}].visible=this.checked" id="colChk${i}">
          <label for="colChk${i}">${c.label}</label>
        </div>
      `).join('');
    }

    window.colDragStart = function(e, idx) { dragIdx = idx; e.dataTransfer.effectAllowed = 'move'; };
    window.colDragOver = function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
    window.colDrop = function(e, toIdx) {
      e.preventDefault();
      if (dragIdx === null || dragIdx === toIdx) return;
      const item = tempColConfig.splice(dragIdx, 1)[0];
      tempColConfig.splice(toIdx, 0, item);
      dragIdx = null;
      renderColSettingsList();
    };

    function applyColSettings() {
      columnConfig = tempColConfig.map(c => ({ ...c }));
      saveColumnConfig(columnConfig);
      document.getElementById('colSettingsOverlay').classList.remove('show');
      refreshAdminTable();
    }

    function resetColSettings() {
      tempColConfig = ALL_COLUMNS.map(c => ({ ...c }));
      renderColSettingsList();
    }

    document.getElementById('colSettingsOverlay').addEventListener('click', function(e) {
      if (e.target === this) this.classList.remove('show');
    });

    // ========== åˆ—å®½æ‹–æ‹½ ==========
    function getColWidthKey() {
      return 'col_widths_' + (currentLoginName || 'default');
    }
    function loadColWidths() {
      try { return JSON.parse(localStorage.getItem(getColWidthKey())) || {}; } catch(e) { return {}; }
    }
    function saveColWidths(widths) {
      localStorage.setItem(getColWidthKey(), JSON.stringify(widths));
    }
    function applyColWidths() {
      const widths = loadColWidths();
      const ths = document.querySelectorAll('#adminTable thead th');
      ths.forEach(th => {
        const label = th.textContent.trim();
        if (widths[label]) {
          th.style.width = widths[label] + 'px';
          th.style.minWidth = widths[label] + 'px';
        }
      });
    }

    (function initColResize() {
      let resizing = null;
      document.addEventListener('mousedown', function(e) {
        if (!e.target.classList.contains('col-resizer')) return;
        const th = e.target.parentElement;
        resizing = { th, startX: e.pageX, startW: th.offsetWidth };
        e.target.classList.add('active');
        e.preventDefault();
      });
      document.addEventListener('mousemove', function(e) {
        if (!resizing) return;
        const w = Math.max(40, resizing.startW + (e.pageX - resizing.startX));
        resizing.th.style.width = w + 'px';
        resizing.th.style.minWidth = w + 'px';
      });
      document.addEventListener('mouseup', function() {
        if (resizing) {
          resizing.th.querySelector('.col-resizer').classList.remove('active');
          const widths = loadColWidths();
          const label = resizing.th.textContent.trim();
          widths[label] = resizing.th.offsetWidth;
          saveColWidths(widths);
          resizing = null;
        }
      });
    })();

    function exportExcel() {
      const filtered = getFilteredDevices();
      if (filtered.length === 0) { alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); return; }
      const headers = ['å®¢æˆ·ç¼–å·','å‹å·','åºåˆ—å·','MACåœ°å€','è´­ä¹°æ—¥æœŸ','ç»´ä¿é€‰æ‹©','éœ€æ›´æ¢é…ä»¶','éœ€ä»˜è´¹','æ•…éšœæè¿°','ç»´ä¿®çŠ¶æ€','ç™»è®°æ—¥æœŸ','å¯„å›å¿«é€’','å¯„å‡ºå¿«é€’','å¯„å›åœ°å€','å¤‡æ³¨'];
      const keys = ['customerId','model','sn','mac','purchaseDate','warrantyType','parts','repairFee','faultDesc','repairStatus','registerDate','returnTracking','sendTracking','returnAddress','remark'];
      let csv = '\uFEFF' + headers.join(',') + '\n';
      filtered.forEach(d => {
        csv += keys.map(k => {
          let v = (d[k] || '').toString().replace(/"/g, '""');
          if (v.includes(',') || v.includes('\n') || v.includes('"')) v = `"${v}"`;
          return v;
        }).join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ç»´ä¿®è®°å½•_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ========== ä¿®æ”¹å¯†ç  ==========
    document.getElementById('pwdForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const oldPwd = document.getElementById('oldPwd').value;
      const newPwd = document.getElementById('newPwd').value;
      const confirmPwd = document.getElementById('confirmPwd').value;
      const errorEl = document.getElementById('pwdError');

      if (newPwd.length < 6) {
        errorEl.textContent = 'æ–°å¯†ç è‡³å°‘6ä½';
        return;
      }
      if (newPwd !== confirmPwd) {
        errorEl.textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´';
        return;
      }

      try {
        if (!currentUserId) { errorEl.textContent = 'æœªç™»å½•'; return; }
        const checkRes = await supabase.from('staff')
          .select('id,password')
          .eq('id', currentUserId);
        if (checkRes.error) throw checkRes.error;
        const me = checkRes.data && checkRes.data[0];
        if (!me || me.password !== oldPwd) {
          errorEl.textContent = 'å½“å‰å¯†ç é”™è¯¯';
          return;
        }
        const updateRes = await supabase.from('staff')
          .update({ password: newPwd })
          .eq('id', currentUserId);
        if (updateRes.error) throw updateRes.error;
        closeModal('pwdModal');
        alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
      } catch (err) {
        errorEl.textContent = 'ä¿®æ”¹å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯');
      }
    });

    // ========== äººå‘˜ç®¡ç† ==========
    let staffList = [];

    async function loadStaff() {
      try {
        const res = await supabase.from('staff').select('*').order('created_at', { ascending: true });
        if (res.error) throw res.error;
        staffList = res.data || [];
      } catch (err) {
        console.error('åŠ è½½äººå‘˜å¤±è´¥:', err);
      }
    }

    function refreshStaffTable() {
      loadStaff().then(() => {
        const tbody = document.getElementById('staffTableBody');
        const roleLabel = { admin: 'ç®¡ç†å‘˜', operator: 'æ“ä½œå‘˜' };
        tbody.innerHTML = staffList.map(s => `
          <tr>
            <td>${s.username}</td>
            <td>${s.name || '-'}</td>
            <td>${roleLabel[s.role] || s.role}</td>
            <td>${s.is_active ? '<span style="color:var(--success);">å¯ç”¨</span>' : '<span style="color:var(--danger);">ç¦ç”¨</span>'}</td>
            <td>${s.created_at ? new Date(s.created_at).toLocaleDateString('zh-CN') : '-'}</td>
            <td>
              <button class="btn btn-secondary" style="font-size:0.72rem;padding:3px 8px;margin-right:4px;" onclick="editStaffUI(${s.id})">ç¼–è¾‘</button>
              <button class="btn btn-secondary" style="font-size:0.72rem;padding:3px 8px;margin-right:4px;" onclick="resetStaffPwdUI(${s.id},'${s.username}')">é‡ç½®å¯†ç </button>
              ${s.username !== '000' ? `<button class="btn" style="font-size:0.72rem;padding:3px 8px;color:var(--danger);border:1px solid var(--danger);" onclick="deleteStaffUI(${s.id},'${s.username}')">åˆ é™¤</button>` : ''}
            </td>
          </tr>
        `).join('');
        document.getElementById('staffStatsInfo').textContent = `å…± ${staffList.length} åäººå‘˜`;
      });
    }

    function openStaffForm(mode, staffId) {
      document.getElementById('staffEditMode').value = mode;
      document.getElementById('staffEditId').value = staffId || '';
      document.getElementById('staffForm').reset();

      if (mode === 'edit' && staffId) {
        const s = staffList.find(x => x.id === staffId);
        if (s) {
          document.getElementById('staffUsername').value = s.username;
          document.getElementById('staffName').value = s.name || '';
          document.getElementById('staffPassword').value = s.password;
          document.getElementById('staffRole').value = s.role;
          document.getElementById('staffActive').value = String(s.is_active);
          document.getElementById('staffUsername').readOnly = (s.username === '000');
        }
        document.getElementById('staffModalTitle').textContent = 'ç¼–è¾‘äººå‘˜';
      } else {
        document.getElementById('staffUsername').readOnly = false;
        document.getElementById('staffModalTitle').textContent = 'æ–°å¢äººå‘˜';
      }
      openModal('staffModal');
    }

    document.getElementById('staffForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = document.getElementById('staffEditMode').value;
      const staffId = document.getElementById('staffEditId').value;
      const data = {
        username: document.getElementById('staffUsername').value.trim(),
        name: document.getElementById('staffName').value.trim(),
        password: document.getElementById('staffPassword').value,
        role: document.getElementById('staffRole').value,
        is_active: document.getElementById('staffActive').value === 'true',
      };
      if (!data.username || !data.password) {
        alert('å·¥å·å’Œå¯†ç ä¸èƒ½ä¸ºç©º');
        return;
      }
      try {
        if (mode === 'edit' && staffId) {
          const res = await supabase.from('staff').update(data).eq('id', parseInt(staffId));
          if (res.error) throw res.error;
        } else {
          const res = await supabase.from('staff').insert([data]);
          if (res.error) throw res.error;
        }
        closeModal('staffModal');
        refreshStaffTable();
      } catch (err) {
        alert('ä¿å­˜å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯'));
      }
    });

    window.editStaffUI = function(id) {
      openStaffForm('edit', id);
    };

    window.resetStaffPwdUI = async function(id, username) {
      if (confirm(`ç¡®å®šå°† "${username}" çš„å¯†ç é‡ç½®ä¸º 000000ï¼Ÿ`)) {
        try {
          const res = await supabase.from('staff').update({ password: '000000' }).eq('id', id);
          if (res.error) throw res.error;
          alert('å¯†ç å·²é‡ç½®ä¸º 000000');
        } catch (err) {
          alert('é‡ç½®å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯'));
        }
      }
    };

    window.deleteStaffUI = async function(id, username) {
      if (confirm(`ç¡®å®šåˆ é™¤äººå‘˜ "${username}"ï¼Ÿ`)) {
        try {
          const res = await supabase.from('staff').delete().eq('id', id);
          if (res.error) throw res.error;
          refreshStaffTable();
        } catch (err) {
          alert('åˆ é™¤å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯'));
        }
      }
    };

    // ========== ç®¡ç†å‘˜ç™»å½• ==========
    document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorEl = document.getElementById('loginError');
      const btn = e.target.querySelector('.login-btn');
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value;
      errorEl.textContent = '';
      btn.disabled = true;
      btn.querySelector('.login-btn-text').textContent = 'éªŒè¯ä¸­...';

      try {
        const res = await supabase.from('staff')
          .select('*')
          .eq('username', username)
          .eq('is_active', true);
        if (res.error) throw res.error;
        if (!res.data || res.data.length === 0) {
          errorEl.textContent = 'å·¥å·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨';
          return;
        }
        const user = res.data[0];
        if (user.password !== password) {
          errorEl.textContent = 'å¯†ç é”™è¯¯';
          return;
        }
        isAdmin = true;
        currentUserRole = user.role;
        currentUserId = user.id;
        currentLoginName = user.username;
        currentUsername = user.name || user.username;
        updateAdminUI();
      } catch (err) {
        errorEl.textContent = 'ç™»å½•å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯');
      } finally {
        btn.disabled = false;
        btn.querySelector('.login-btn-text').textContent = 'ç™» å½•';
      }
    });

    function doAdminLogout() {
      if (confirm('ç¡®å®šé€€å‡ºï¼Ÿ')) {
        isAdmin = false;
        currentUserRole = '';
        currentUserId = null;
        currentLoginName = '';
        currentUsername = '';
        switchAdminTab('devices');
        document.getElementById('adminLoginForm').reset();
        document.getElementById('loginError').textContent = '';
        updateAdminUI();
      }
    }

    document.getElementById('adminLogoutBtn').addEventListener('click', doAdminLogout);

    document.getElementById('adminChangePwdBtn').addEventListener('click', () => {
      document.getElementById('pwdForm').reset();
      document.getElementById('pwdError').textContent = '';
      document.getElementById('pwdModalTitle').textContent =
        currentUserRole === 'admin' ? 'ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ' : 'ä¿®æ”¹æ“ä½œå‘˜å¯†ç ';
      openModal('pwdModal');
    });

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal(modal.id);
      });
    });

    // ========== é¡µé¢åˆå§‹åŒ– ==========
    (async function init() {
      try {
        await loadDevicesFromCloud();
      } catch (err) {
        console.error('åˆå§‹æ•°æ®åŠ è½½å¤±è´¥:', err);
      }
      showLoginPage();
    })();
  </script>
</body>
</html>
